<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Cubes Fight: Ultimate Visual Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    /* =========================================
       ESTILOS VISUALES PREMIUM (CSS) - MODIFICADO
       ========================================= */
    :root {
      --bg-color: #F0F2F5;
      --accent-blue: #2979FF;
      --accent-red: #FF1744;
      --accent-shield: #00E5FF;
      --accent-energy: #FFD700;
      --energy-glow: rgba(255, 215, 0, 0.6);
      --shadow-soft: 0 15px 35px rgba(0,0,0,0.15);
      --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      /* Variables para colores personalizados */
      --player-color: #2979FF;
      --player-color-dark: #2962FF;
      --player-color-glow: rgba(41, 121, 255, 0.6);
      --boss-color: #FF1744;
      --boss-color-dark: #D50000;
      --boss-color-glow: rgba(255, 23, 68, 0.6);
    }

    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-color);
      font-family: var(--font-main);
      overflow: hidden;
      user-select: none;
      touch-action: none;
    }

    /* MEN√ö PRINCIPAL - MODIFICADO CON SELECTOR VERSI√ìN */
    #mainMenu {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      animation: fadeIn 0.8s ease-out;
    }

    .menu-content {
      background: rgba(255, 255, 255, 0.95);
      padding: 40px 60px;
      border-radius: 20px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      text-align: center;
      transform: translateY(0);
      animation: floatUp 0.6s ease-out 0.3s both;
      border: 2px solid rgba(255, 255, 255, 0.2);
      min-width: 500px;
      max-width: 800px;
    }

    .menu-title {
      font-size: 64px;
      font-weight: 900;
      background: linear-gradient(90deg, #2979FF, #FF1744);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0 0 20px 0;
      text-transform: uppercase;
      letter-spacing: 3px;
      text-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .menu-subtitle {
      font-size: 22px;
      color: #666;
      margin-bottom: 30px;
      font-weight: 500;
      letter-spacing: 1px;
    }

    /* CONTENEDOR DE SELECTOR DE VERSI√ìN */
    .version-selector {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      justify-content: center;
    }

    .version-button {
      padding: 20px 30px;
      font-size: 20px;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      font-weight: 700;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      min-width: 180px;
    }

    .version-button.pc {
      background: linear-gradient(135deg, #2979FF, #2962FF);
      color: white;
      box-shadow: 0 10px 30px rgba(41, 121, 255, 0.4);
    }

    .version-button.mobile {
      background: linear-gradient(135deg, #4CAF50, #2E7D32);
      color: white;
      box-shadow: 0 10px 30px rgba(76, 175, 80, 0.4);
    }

    .version-button:hover {
      transform: translateY(-5px) scale(1.05);
    }

    .version-icon {
      font-size: 32px;
    }

    .menu-button {
      padding: 18px 50px;
      font-size: 22px;
      background: linear-gradient(90deg, #2979FF, #2962FF);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 800;
      letter-spacing: 1.5px;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 10px 30px rgba(41, 121, 255, 0.4);
      text-transform: uppercase;
      width: 100%;
      margin-bottom: 15px;
    }

    .menu-button.boss-mode {
      background: linear-gradient(90deg, #FF1744, #D50000);
      box-shadow: 0 10px 30px rgba(255, 23, 68, 0.4);
    }

    .menu-button.color-customize {
      background: linear-gradient(90deg, #9C27B0, #673AB7);
      box-shadow: 0 10px 30px rgba(156, 39, 176, 0.4);
    }

    /* BOT√ìN BORRAR PROGRESO - NUEVO */
    .menu-button.delete-progress {
      background: linear-gradient(90deg, #FF9800, #F57C00);
      box-shadow: 0 10px 30px rgba(255, 152, 0, 0.4);
    }

    .menu-button:hover {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 0 15px 40px rgba(41, 121, 255, 0.6);
    }

    .menu-button.boss-mode:hover {
      background: linear-gradient(90deg, #D50000, #FF1744);
      box-shadow: 0 15px 40px rgba(255, 23, 68, 0.6);
    }

    .menu-button.color-customize:hover {
      background: linear-gradient(90deg, #673AB7, #9C27B0);
      box-shadow: 0 15px 40px rgba(156, 39, 176, 0.6);
    }

    .menu-button.delete-progress:hover {
      background: linear-gradient(90deg, #F57C00, #FF9800);
      box-shadow: 0 15px 40px rgba(255, 152, 0, 0.6);
    }

    .menu-button:active {
      transform: translateY(2px) scale(0.98);
    }

    /* MEN√ö DE CONFIRMACI√ìN BORRAR PROGRESO - NUEVO */
    #deleteProgressMenu {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 101;
      animation: fadeIn 0.5s ease-out;
    }

    /* MEN√ö DE DIFICULTAD */
    #difficultyMenu {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 101;
      animation: fadeIn 0.5s ease-out;
    }

    .difficulty-button {
      padding: 18px 50px;
      font-size: 22px;
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 800;
      letter-spacing: 1.5px;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      text-transform: uppercase;
      width: 100%;
      margin-bottom: 15px;
    }

    .difficulty-button.easy {
      background: linear-gradient(90deg, #4CAF50, #2E7D32);
      box-shadow: 0 10px 30px rgba(76, 175, 80, 0.4);
    }

    .difficulty-button.medium {
      background: linear-gradient(90deg, #FF9800, #F57C00);
      box-shadow: 0 10px 30px rgba(255, 152, 0, 0.4);
    }

    .difficulty-button.hard {
      background: linear-gradient(90deg, #F44336, #D32F2F);
      box-shadow: 0 10px 30px rgba(244, 67, 54, 0.4);
    }

    .difficulty-button.extreme {
      background: linear-gradient(90deg, #9C27B0, #7B1FA2);
      box-shadow: 0 10px 30px rgba(156, 39, 176, 0.4);
    }

    .difficulty-button.impossible {
      background: linear-gradient(90deg, #212121, #000000);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
    }

    /* MEN√ö DE SELECCI√ìN DE NIVELES */
    #levelMenu {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 101;
      animation: fadeIn 0.5s ease-out;
    }

    /* MEN√ö DE PERSONALIZACI√ìN DE COLORES */
    #colorMenu {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 101;
      animation: fadeIn 0.5s ease-out;
    }

    .menu-container {
      background: rgba(255, 255, 255, 0.95);
      padding: 40px 60px;
      border-radius: 20px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      text-align: center;
      min-width: 500px;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .menu-title {
      font-size: 36px;
      font-weight: 900;
      background: linear-gradient(90deg, #2979FF, #FF1744);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0 0 30px 0;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    /* GRID DE NIVELES */
    .levels-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 15px;
      margin-bottom: 30px;
    }

    .level-button {
      padding: 20px 0;
      font-size: 24px;
      font-weight: 900;
      color: white;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 80px;
      position: relative;
    }

    .level-button.unlocked {
      background: linear-gradient(135deg, #2979FF, #2962FF);
    }

    .level-button.locked {
      background: linear-gradient(135deg, #9E9E9E, #757575);
      cursor: not-allowed;
      opacity: 0.7;
    }

    .level-button:hover:not(.locked) {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }

    .level-number {
      font-size: 28px;
      margin-bottom: 5px;
    }

    .level-difficulty {
      font-size: 12px;
      font-weight: 700;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .lock-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 18px;
    }

    /* CONTROLES DE COLOR RGB */
    .color-controls {
      display: flex;
      flex-direction: column;
      gap: 25px;
      margin: 30px 0;
    }

    .color-section {
      background: rgba(0, 0, 0, 0.05);
      padding: 20px;
      border-radius: 15px;
      text-align: left;
    }

    .color-title {
      font-size: 22px;
      font-weight: 700;
      color: #333;
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .color-preview {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      margin-bottom: 15px;
      border: 3px solid #333;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .color-slider {
      width: 100%;
      margin: 10px 0;
      -webkit-appearance: none;
      height: 8px;
      border-radius: 4px;
      outline: none;
    }

    .color-slider.red {
      background: linear-gradient(90deg, #000, #F00);
    }

    .color-slider.green {
      background: linear-gradient(90deg, #000, #0F0);
    }

    .color-slider.blue {
      background: linear-gradient(90deg, #000, #00F);
    }

    .color-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: white;
      border: 3px solid #333;
      cursor: pointer;
      box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    }

    .color-value {
      font-size: 16px;
      font-weight: 700;
      color: #333;
      margin-top: 5px;
      text-align: center;
    }

    .color-row {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 15px;
    }

    .color-label {
      font-size: 16px;
      font-weight: 700;
      color: #333;
      min-width: 80px;
    }

    .back-button {
      padding: 12px 30px;
      font-size: 16px;
      background: #757575;
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 1px;
      transition: all 0.2s ease;
      margin-top: 10px;
    }

    .back-button:hover {
      background: #616161;
      transform: translateY(-2px);
    }

    /* CONTENEDOR PRINCIPAL DEL JUEGO */
    #gameWrapper {
      position: relative;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      gap: 20px;
      z-index: 1;
    }

    /* INTERFAZ (HUD) */
    #hud {
      width: 800px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px; /* A√±adido */
    }

    /* BARRA DE ENERG√çA - MODIFICADO: sin brecha dorada */
    #energyContainer {
      width: 800px;
      margin-top: 5px; /* Cambiado */
      opacity: 0;
      transition: opacity 0.5s ease;
      display: none;
      flex-direction: column;
      gap: 5px;
    }
    
    #energyContainer.active {
      opacity: 1;
      display: flex;
    }
    
    .energy-title {
      font-size: 14px;
      font-weight: 900;
      color: #FFD700;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      margin-bottom: 5px;
    }
    
    .energy-bar-container {
      width: 100%;
      height: 24px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2), inset 0 2px 4px rgba(0,0,0,0.1);
      border: 2px solid rgba(255, 215, 0, 0.3);
    }
    
    .energy-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #FFC107, #FFD700, #FF9800);
      border-radius: 12px;
      transition: width 0.3s ease;
      position: relative;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.7), inset 0 2px 0 rgba(255,255,255,0.3);
    }
    
    .energy-bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255, 255, 255, 0.4) 50%, 
        transparent 100%);
      animation: energyShine 2s infinite;
      border-radius: 12px;
    }
    
    .energy-bar-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 12px;
      font-weight: 900;
      color: #FFF;
      text-shadow: 0 2px 4px rgba(0,0,0,0.8);
      z-index: 2;
      letter-spacing: 1px;
    }
    
    .energy-instruction {
      font-size: 11px;
      color: #FFD700;
      text-align: center;
      font-weight: 600;
      margin-top: 5px;
      opacity: 0.9;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }

    .bar-container {
      width: 100%;
      height: 28px;
      background: #E0E0E0;
      border-radius: 14px;
      position: relative;
      overflow: hidden;
      box-shadow: inset 0 3px 6px rgba(0,0,0,0.15);
      border: 1px solid rgba(255,255,255,0.5);
    }

    .bar-fill {
      height: 100%;
      width: 100%;
      border-radius: 14px;
      transition: width 0.4s cubic-bezier(0.25, 1, 0.5, 1), background-color 0.3s;
      position: relative;
    }

    .bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 50%;
      background: linear-gradient(180deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.1) 100%);
      border-radius: 14px 14px 0 0;
    }

    /* BARRAS CON COLORES PERSONALIZADOS */
    #playerBar { 
      background: linear-gradient(90deg, var(--player-color), var(--player-color-dark)); 
      box-shadow: 0 0 15px var(--player-color-glow); 
    }
    #bossBar { 
      background: linear-gradient(90deg, var(--boss-color), var(--boss-color-dark)); 
      box-shadow: 0 0 15px var(--boss-color-glow); 
    }
    #shieldBar { 
      background: linear-gradient(90deg, #00B8D4, #00E5FF); 
      box-shadow: 0 0 20px rgba(0, 229, 255, 0.8); 
    }

    .bar-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 13px;
      font-weight: 900;
      color: #FFF;
      text-shadow: 0 2px 4px rgba(0,0,0,0.6);
      z-index: 2;
      letter-spacing: 1px;
    }

    /* CONTENEDOR DEL ESCUDO */
    #shieldContainer {
      width: 100%;
      height: 0;
      opacity: 0;
      transition: all 0.5s ease;
      transform: scale(0.95);
      visibility: hidden;
      overflow: hidden;
    }
    #shieldContainer.active {
      opacity: 1;
      visibility: visible;
      transform: scale(1);
      height: 28px;
    }

    /* BOT√ìN MANUAL DEL ESCUDO */
    #shieldButtonContainer {
      position: absolute;
      bottom: -50px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
    }
    
    #shieldButtonContainer.active {
      opacity: 1;
      pointer-events: all;
    }
    
    #shieldManualButton {
      padding: 10px 25px;
      font-size: 16px;
      background: linear-gradient(90deg, #00B8D4, #00E5FF);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 1px;
      box-shadow: 0 5px 20px rgba(0, 229, 255, 0.6);
      transition: all 0.3s ease;
    }
    
    #shieldManualButton:hover:not(:disabled) {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 8px 25px rgba(0, 229, 255, 0.8);
    }
    
    #shieldManualButton:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* CANVAS & CONTENEDOR DE JUEGO */
    #canvasContainer {
      position: relative;
      padding: 0;
      background: #FFF;
      border-radius: 8px;
      box-shadow: var(--shadow-soft);
      border: 5px solid #222;
      overflow: hidden;
    }

    canvas {
      display: block;
      background: radial-gradient(circle at center, #ffffff 0%, #f0f0f0 100%);
      cursor: crosshair;
    }

    /* VI√ëETA ROJA DE DA√ëO */
    #damageVignette {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 5;
      background: radial-gradient(circle, transparent 60%, rgba(255, 0, 0, 0.6) 100%);
      opacity: 0;
      transition: opacity 0.6s ease-out;
    }
    #damageVignette.active {
      opacity: 1;
      transition: opacity 0.1s ease-in;
    }

    /* AURA DORADA DEL RESORTE - MEJORADA */
    #springAura {
      position: absolute;
      pointer-events: none;
      z-index: 3;
      opacity: 0;
      transition: opacity 0.5s ease-out;
      border-radius: 50%;
      filter: blur(10px);
    }
    
    #springAura.active {
      opacity: 0.9;
      animation: springGlow 1s infinite alternate ease-in-out;
    }
    
    .spring-emoji {
      position: absolute;
      font-size: 48px;
      text-shadow: 0 0 20px #FFD700;
      animation: springFloat 1s infinite alternate ease-in-out;
      z-index: 4;
    }

    /* PANTALLA FIN DE JUEGO */
    #overlay {
      position: absolute;
      inset: 0;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(8px);
      display: none;
      flex-direction column;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    .overlay-content {
      text-align: center;
      background: rgba(255, 255, 255, 0.95);
      padding: 50px;
      border-radius: 20px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      min-width: 500px;
    }

    h1 { 
      margin: 0 0 25px 0; 
      font-size: 56px; 
      color: #333; 
      text-transform: uppercase; 
      letter-spacing: 4px; 
      text-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .overlay-buttons {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 30px;
      flex-wrap: wrap;
    }
    
    .overlay-button {
      padding: 15px 40px;
      font-size: 18px;
      color: #FFF;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 800;
      letter-spacing: 1px;
      transition: all 0.2s ease;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      min-width: 180px;
    }
    
    .restart-button {
      background: #222;
    }
    
    .menu-return-button {
      background: #757575;
    }
    
    .next-level-button {
      background: linear-gradient(90deg, #4CAF50, #2E7D32);
      box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
    }
    
    .overlay-button:hover { 
      transform: translateY(-2px) scale(1.05); 
      box-shadow: 0 8px 25px rgba(0,0,0,0.4);
    }
    
    .next-level-button:hover {
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.6);
    }
    
    .overlay-button:active { 
      transform: translateY(1px) scale(0.98); 
    }

    /* CONTROLES / AYUDA - MODIFICADO: sin brecha dorada */
    #controls {
      margin-top: 15px;
      font-size: 14px;
      color: #666;
      text-align: center;
      line-height: 1.8;
      font-weight: 500;
      background: rgba(255, 255, 255, 0.9);
      padding: 15px 25px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      border: 1px solid rgba(0,0,0,0.1);
      width: 800px;
    }
    
    .key {
      display: inline-block;
      padding: 4px 8px;
      border: 1px solid #BBB;
      border-radius: 6px;
      background: #FFF;
      font-weight: 800;
      color: #444;
      font-size: 12px;
      box-shadow: 0 2px 0 #CCC;
      margin: 0 2px;
      min-width: 30px;
      text-align: center;
    }
    
    .energy-key {
      background: linear-gradient(90deg, #FFC107, #FFD700);
      color: #333;
      border-color: #FF9800;
      box-shadow: 0 2px 0 #FF9800, 0 0 10px rgba(255, 215, 0, 0.3);
    }
    
    .controls-row {
      margin: 8px 0;
    }
    
    .energy-requirement {
      color: #FF9800;
      font-weight: 700;
      margin-top: 10px;
      padding: 8px 12px;
      background: rgba(255, 215, 0, 0.1);
      border-radius: 8px;
      /* border-left: 3px solid #FFD700; */ /* ELIMINADO: brecha dorada */
    }

    /* INDICADOR DE MODO Y NIVEL */
    #modeIndicator {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: 700;
      font-size: 14px;
      letter-spacing: 1px;
      z-index: 10;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }

    .mode-normal {
      background: linear-gradient(90deg, var(--player-color), var(--player-color-dark));
    }
    
    .mode-boss {
      background: linear-gradient(90deg, var(--boss-color), var(--boss-color-dark));
    }

    .level-indicator {
      font-size: 12px;
      opacity: 0.9;
      font-weight: 600;
    }

    /* CONTROLES T√ÅCTILES PARA M√ìVIL */
    #mobileControls {
      position: absolute;
      bottom: 20px;
      left: 0;
      right: 0;
      display: none;
      justify-content: space-between;
      padding: 0 30px;
      z-index: 10;
      pointer-events: none;
    }

    .mobile-controls.active {
      display: flex;
    }

    .joystick-area {
      width: 150px;
      height: 150px;
      position: relative;
      pointer-events: all;
    }

    .joystick-base {
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .joystick-handle {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70px;
      height: 70px;
      background: linear-gradient(135deg, var(--player-color), var(--player-color-dark));
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 10px 20px rgba(0,0,0,0.4);
      transition: transform 0.1s;
    }

    .joystick-handle.boss {
      background: linear-gradient(135deg, var(--boss-color), var(--boss-color-dark));
    }

    .mobile-buttons {
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: flex-end;
      pointer-events: all;
    }

    .mobile-button {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: none;
      font-size: 16px;
      font-weight: 800;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 5px;
      cursor: pointer;
      transition: all 0.1s;
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
    }

    .mobile-button:active {
      transform: scale(0.95);
      box-shadow: 0 5px 10px rgba(0,0,0,0.2);
    }

    .mobile-button.shoot {
      background: linear-gradient(135deg, #FF1744, #D50000);
      border: 3px solid rgba(255, 255, 255, 0.3);
    }

    .mobile-button.spring {
      background: linear-gradient(135deg, #FFD700, #FF9800);
      border: 3px solid rgba(255, 255, 255, 0.3);
    }

    .mobile-button.shield {
      background: linear-gradient(135deg, #00E5FF, #00B8D4);
      border: 3px solid rgba(255, 255, 255, 0.3);
    }

    .button-icon {
      font-size: 28px;
    }

    .button-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    /* ANIMACIONES NUEVAS - AURA DORADA */
    @keyframes energyShine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    @keyframes springGlow {
      0% { 
        box-shadow: 0 0 30px #FFD700, 0 0 60px #FFD700, 0 0 100px #FFD700; 
        transform: scale(1);
      }
      100% { 
        box-shadow: 0 0 60px #FFD700, 0 0 120px #FFD700, 0 0 150px #FFD700; 
        transform: scale(1.1);
      }
    }
    
    @keyframes springFloat {
      0% { transform: translateY(-5px) rotate(0deg); }
      100% { transform: translateY(5px) rotate(5deg); }
    }
    
    @keyframes hypnotizedGlow {
      0% { box-shadow: 0 0 10px #FFFF00, 0 0 20px #FFFF00; }
      50% { box-shadow: 0 0 20px #FFFF00, 0 0 40px #FFFF00; }
      100% { box-shadow: 0 0 10px #FFFF00, 0 0 20px #FFFF00; }
    }

    /* ANIMACIONES EXISTENTES */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes floatUp {
      from { 
        opacity: 0;
        transform: translateY(30px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ANIMACI√ìN DE ALERTA BORRAR PROGRESO */
    @keyframes warningPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .warning-pulse {
      animation: warningPulse 0.5s ease-in-out 3;
    }

    /* RESPONSIVE PARA M√ìVIL */
    @media (max-width: 850px) {
      .menu-content {
        min-width: 300px;
        max-width: 90%;
        padding: 30px;
      }
      
      .menu-title {
        font-size: 48px;
      }
      
      .version-selector {
        flex-direction: column;
        align-items: center;
      }
      
      #hud, #energyContainer, #controls {
        width: 95%;
        max-width: 800px;
      }
      
      #canvasContainer {
        width: 95%;
        max-width: 800px;
      }
      
      #gameCanvas {
        width: 100%;
        height: auto;
      }
      
      .overlay-content {
        min-width: 300px;
        width: 90%;
        padding: 30px;
      }
      
      .levels-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .mobile-button {
        width: 80px;
        height: 80px;
      }
      
      .joystick-area {
        width: 130px;
        height: 130px;
      }
      
      .joystick-handle {
        width: 60px;
        height: 60px;
      }
    }

  </style>
</head>
<body>

<!-- MEN√ö PRINCIPAL - MODIFICADO CON SELECTOR DE VERSI√ìN -->
<div id="mainMenu">
  <div class="menu-content">
    <h1 class="menu-title">Cubes Fight</h1>
    <p class="menu-subtitle">Ultimate Visual Edition</p>
    
    <!-- SELECTOR DE VERSI√ìN PC/M√ìVIL -->
    <div class="version-selector">
      <button class="version-button pc" id="versionPC">
        <div class="version-icon">üñ•Ô∏è</div>
        <div>VERSI√ìN PC</div>
        <div style="font-size: 12px; opacity: 0.8;">Controles con teclado</div>
      </button>
      <button class="version-button mobile" id="versionMobile">
        <div class="version-icon">üì±</div>
        <div>VERSI√ìN M√ìVIL</div>
        <div style="font-size: 12px; opacity: 0.8;">Controles t√°ctiles</div>
      </button>
    </div>

    <button class="menu-button" id="startButton">MODO NORMAL</button>
    <button class="menu-button boss-mode" id="bossModeButton">MODO YO JEFE</button>
    <button class="menu-button color-customize" id="colorCustomizeButton">PERSONALIZAR COLORES</button>
    <button class="menu-button delete-progress" id="deleteProgressButton">BORRAR PROGRESO</button>
  </div>
</div>

<!-- MEN√ö DE CONFIRMACI√ìN BORRAR PROGRESO -->
<div id="deleteProgressMenu">
  <div class="menu-container">
    <h2 class="menu-title warning-pulse">‚ö†Ô∏è BORRAR PROGRESO</h2>
    <div id="deleteWarningAlert" style="color: #FF1744; font-weight: bold; font-size: 18px; margin-bottom: 15px; animation: fadeIn 0.5s ease-out;">
      ¬°ADVERTENCIA IRREVERSIBLE!
    </div>
    <p style="color: #333; margin: 20px 0; text-align: center; font-size: 16px;">
      Esta acci√≥n eliminar√° TODO tu progreso:<br>
      ‚Ä¢ Niveles desbloqueados<br>
      ‚Ä¢ Colores personalizados<br>
      ‚Ä¢ Estad√≠sticas guardadas
    </p>
    
    <div style="text-align: left; margin: 20px 0; padding: 15px; background: rgba(255,0,0,0.1); border-radius: 10px; border-left: 4px solid #FF1744;">
      <label style="color: #333; font-size: 16px; display: flex; align-items: center; gap: 10px;">
        <input type="checkbox" id="confirmDeleteCheckbox" style="transform: scale(1.3);">
        <span>Entiendo que esta acci√≥n NO se puede deshacer.</span>
      </label>
    </div>
    
    <div style="display: flex; gap: 20px; justify-content: center; margin-top: 30px;">
      <button class="menu-button" id="confirmDeleteButton" style="background: linear-gradient(90deg, #FF1744, #D50000); opacity: 0.5; cursor: not-allowed;" disabled>BORRAR TODO</button>
      <button class="back-button" id="cancelDeleteButton">CANCELAR</button>
    </div>
  </div>
</div>

<!-- MEN√ö DE DIFICULTAD -->
<div id="difficultyMenu">
  <div class="menu-container">
    <h2 class="menu-title">Elige Dificultad</h2>
    <button class="difficulty-button easy" data-difficulty="easy">F√ÅCIL</button>
    <button class="difficulty-button medium" data-difficulty="medium">MEDIO</button>
    <button class="difficulty-button hard" data-difficulty="hard">DIF√çCIL</button>
    <button class="difficulty-button extreme" data-difficulty="extreme">EXTREMO</button>
    <button class="difficulty-button impossible" data-difficulty="impossible">IMPOSIBLE</button>
    <button class="back-button" id="backFromDifficulty">VOLVER</button>
  </div>
</div>

<!-- MEN√ö DE SELECCI√ìN DE NIVELES -->
<div id="levelMenu">
  <div class="menu-container">
    <h2 class="menu-title">Selecciona Nivel</h2>
    <div class="levels-grid" id="levelsGrid">
      <!-- Niveles se generar√°n din√°micamente -->
    </div>
    <button class="back-button" id="backFromLevels">VOLVER</button>
  </div>
</div>

<!-- MEN√ö DE PERSONALIZACI√ìN DE COLORES -->
<div id="colorMenu">
  <div class="menu-container">
    <h2 class="menu-title">Personalizar Colores</h2>
    <div class="color-controls">
      <div class="color-section">
        <h3 class="color-title">Cubo Azul (Jugador)</h3>
        <div class="color-row">
          <div class="color-preview" id="playerColorPreview" style="background: #2979FF;"></div>
          <div style="flex: 1;">
            <div class="color-row">
              <span class="color-label">Rojo (R)</span>
              <input type="range" class="color-slider red" id="playerRed" min="0" max="255" value="41">
              <span class="color-value" id="playerRedValue">41</span>
            </div>
            <div class="color-row">
              <span class="color-label">Verde (G)</span>
              <input type="range" class="color-slider green" id="playerGreen" min="0" max="255" value="121">
              <span class="color-value" id="playerGreenValue">121</span>
            </div>
            <div class="color-row">
              <span class="color-label">Azul (B)</span>
              <input type="range" class="color-slider blue" id="playerBlue" min="0" max="255" value="255">
              <span class="color-value" id="playerBlueValue">255</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="color-section">
        <h3 class="color-title">Cubo Rojo (Jefe)</h3>
        <div class="color-row">
          <div class="color-preview" id="bossColorPreview" style="background: #FF1744;"></div>
          <div style="flex: 1;">
            <div class="color-row">
              <span class="color-label">Rojo (R)</span>
              <input type="range" class="color-slider red" id="bossRed" min="0" max="255" value="255">
              <span class="color-value" id="bossRedValue">255</span>
            </div>
            <div class="color-row">
              <span class="color-label">Verde (G)</span>
              <input type="range" class="color-slider green" id="bossGreen" min="0" max="255" value="23">
              <span class="color-value" id="bossGreenValue">23</span>
            </div>
            <div class="color-row">
              <span class="color-label">Azul (B)</span>
              <input type="range" class="color-slider blue" id="bossBlue" min="0" max="255" value="68">
              <span class="color-value" id="bossBlueValue">68</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <button class="menu-button" id="saveColors">GUARDAR COLORES</button>
    <button class="back-button" id="backFromColors">VOLVER</button>
  </div>
</div>

<!-- CONTENEDOR DEL JUEGO -->
<div id="gameWrapper">
  <!-- Indicador de modo y nivel -->
  <div id="modeIndicator" class="mode-normal">
    <div>MODO NORMAL</div>
    <div class="level-indicator" id="levelIndicator">NIVEL 1</div>
  </div>
  
  <div id="hud">
    <div class="bar-container">
      <div id="bossBar" class="bar-fill"></div>
      <div id="bossText" class="bar-text">JEFE: 100%</div>
    </div>

    <!-- CONTENEDOR DEL ESCUDO -->
    <div id="shieldContainer">
      <div class="bar-container" style="border-color: #00E5FF;">
        <div id="shieldBar" class="bar-fill"></div>
        <div id="shieldText" class="bar-text">ESCUDO: 100%</div>
      </div>
    </div>

    <div class="bar-container">
      <div id="playerBar" class="bar-fill"></div>
      <div id="playerText" class="bar-text">JUGADOR: 100%</div>
    </div>
  </div>
  
  <!-- CONTENEDOR DE ENERG√çA -->
  <div id="energyContainer">
    <div class="energy-title">ENERG√çA</div>
    <div class="energy-bar-container">
      <div id="energyBar" class="energy-bar-fill"></div>
      <div id="energyText" class="energy-bar-text">0/100</div>
    </div>
    <div class="energy-instruction">Necesitas 100 impactos al jefe para cargar la energ√≠a.</div>
  </div>

  <div id="canvasContainer">
    <canvas id="gameCanvas" width="800" height="500"></canvas>
    
    <!-- Aura del resorte - MEJORADA -->
    <div id="springAura"></div>
    
    <!-- Bot√≥n manual del escudo -->
    <div id="shieldButtonContainer">
      <button id="shieldManualButton" disabled>ACTIVAR ESCUDO (Tecla Q)</button>
    </div>
    
    <div id="damageVignette"></div>

    <div id="overlay">
      <div class="overlay-content">
        <h1 id="overlayTitle">VICTORIA</h1>
        <div class="overlay-buttons" id="overlayButtons">
          <!-- Botones se insertar√°n din√°micamente -->
        </div>
      </div>
    </div>
  </div>

  <!-- CONTROLES T√ÅCTILES PARA M√ìVIL -->
  <div id="mobileControls">
    <div class="joystick-area">
      <div class="joystick-base"></div>
      <div class="joystick-handle" id="joystickHandle"></div>
    </div>
    
    <div class="mobile-buttons">
      <button class="mobile-button shoot" id="mobileShootButton">
        <div class="button-icon">üî¥</div>
        <div class="button-label">DISPARAR</div>
      </button>
      <button class="mobile-button spring" id="mobileSpringButton">
        <div class="button-icon">üåÄ</div>
        <div class="button-label">RESORTE</div>
      </button>
      <button class="mobile-button shield" id="mobileShieldButton" style="display: none;">
        <div class="button-icon">üõ°Ô∏è</div>
        <div class="button-label">ESCUDO</div>
      </button>
    </div>
  </div>

  <div id="controls">
    <div class="controls-row">
      <span id="normalControls">
        <span class="key">W</span><span class="key">A</span><span class="key">S</span><span class="key">D</span> Moverse &nbsp;|&nbsp; 
        <span class="key">ESPACIO</span> Disparar &nbsp;|&nbsp;
        <span class="key energy-key">Q</span> Resorte de Energ√≠a
      </span>
      <span id="bossControls" style="display:none;">
        <span class="key">A</span><span class="key">D</span> Moverse &nbsp;|&nbsp; 
        <span class="key">ESPACIO</span> Disparar &nbsp;|&nbsp;
        <span class="key">Q</span> Escudo Manual
      </span>
    </div>
    <div class="energy-requirement" id="energyRequirement">
      ‚ö° Necesitas 100 impactos al jefe para activar el Resorte.
    </div>
    <div class="controls-row">
      <span style="color:#FF1744">‚ö† Cuidado con el desangrado (<40% HP)</span>
    </div>
  </div>
</div>

<script>
/**
 * SISTEMA DE JUEGO COMPLETO CON TODAS LAS MEJORAS
 * CORREGIDO: Mec√°nica del resorte, proyectiles del jefe
 * A√ëADIDO: Selector PC/M√≥vil, controles t√°ctiles
 */

// ==============================
// SISTEMA DE ALMACENAMIENTO - MEJORADO
// ==============================
const Storage = {
  KEYS: {
    UNLOCKED_LEVELS: 'cubes_fight_unlocked_levels',
    PLAYER_COLOR: 'cubes_fight_player_color',
    BOSS_COLOR: 'cubes_fight_boss_color',
    SELECTED_VERSION: 'cubes_fight_selected_version'
  },
  
  init() {
    // Niveles desbloqueados (nivel 1 siempre desbloqueado)
    if (!localStorage.getItem(this.KEYS.UNLOCKED_LEVELS)) {
      localStorage.setItem(this.KEYS.UNLOCKED_LEVELS, JSON.stringify([1]));
    }
    
    // Colores predeterminados
    if (!localStorage.getItem(this.KEYS.PLAYER_COLOR)) {
      localStorage.setItem(this.KEYS.PLAYER_COLOR, JSON.stringify({r: 41, g: 121, b: 255}));
    }
    
    if (!localStorage.getItem(this.KEYS.BOSS_COLOR)) {
      localStorage.setItem(this.KEYS.BOSS_COLOR, JSON.stringify({r: 255, g: 23, b: 68}));
    }
    
    // Versi√≥n seleccionada (PC por defecto)
    if (!localStorage.getItem(this.KEYS.SELECTED_VERSION)) {
      localStorage.setItem(this.KEYS.SELECTED_VERSION, 'pc');
    }
  },
  
  getUnlockedLevels() {
    return JSON.parse(localStorage.getItem(this.KEYS.UNLOCKED_LEVELS)) || [1];
  },
  
  unlockLevel(level) {
    const unlocked = this.getUnlockedLevels();
    if (!unlocked.includes(level)) {
      unlocked.push(level);
      unlocked.sort((a, b) => a - b);
      localStorage.setItem(this.KEYS.UNLOCKED_LEVELS, JSON.stringify(unlocked));
    }
  },
  
  getPlayerColor() {
    const color = JSON.parse(localStorage.getItem(this.KEYS.PLAYER_COLOR));
    return color || {r: 41, g: 121, b: 255};
  },
  
  getBossColor() {
    const color = JSON.parse(localStorage.getItem(this.KEYS.BOSS_COLOR));
    return color || {r: 255, g: 23, b: 68};
  },
  
  getSelectedVersion() {
    return localStorage.getItem(this.KEYS.SELECTED_VERSION) || 'pc';
  },
  
  savePlayerColor(r, g, b) {
    localStorage.setItem(this.KEYS.PLAYER_COLOR, JSON.stringify({r, g, b}));
    this.updateCSSColors();
  },
  
  saveBossColor(r, g, b) {
    localStorage.setItem(this.KEYS.BOSS_COLOR, JSON.stringify({r, g, b}));
    this.updateCSSColors();
  },
  
  saveSelectedVersion(version) {
    localStorage.setItem(this.KEYS.SELECTED_VERSION, version);
  },
  
  // BORRAR TODO EL PROGRESO
  deleteAllProgress() {
    localStorage.removeItem(this.KEYS.UNLOCKED_LEVELS);
    localStorage.removeItem(this.KEYS.PLAYER_COLOR);
    localStorage.removeItem(this.KEYS.BOSS_COLOR);
    localStorage.removeItem(this.KEYS.SELECTED_VERSION);
    this.init(); // Reiniciar con valores por defecto
    this.updateCSSColors();
  },
  
  // Actualizar variables CSS con colores guardados
  updateCSSColors() {
    const playerColor = this.getPlayerColor();
    const bossColor = this.getBossColor();
    
    // Convertir a formato HEX
    const playerHex = Utils.rgbToHex(playerColor.r, playerColor.g, playerColor.b);
    const bossHex = Utils.rgbToHex(bossColor.r, bossColor.g, bossColor.b);
    
    // Calcular versiones oscuras para gradientes
    const playerDark = Utils.adjustColor(playerHex, -30);
    const bossDark = Utils.adjustColor(bossHex, -30);
    
    // Calcular versiones glow con opacidad
    const playerGlow = `${playerHex}99`;
    const bossGlow = `${bossHex}99`;
    
    // Actualizar variables CSS
    document.documentElement.style.setProperty('--player-color', playerHex);
    document.documentElement.style.setProperty('--player-color-dark', playerDark);
    document.documentElement.style.setProperty('--player-color-glow', playerGlow);
    
    document.documentElement.style.setProperty('--boss-color', bossHex);
    document.documentElement.style.setProperty('--boss-color-dark', bossDark);
    document.documentElement.style.setProperty('--boss-color-glow', bossGlow);
  }
};

// ==============================
// CONFIGURACI√ìN DEL JUEGO
// ==============================
const CONFIG = {
  width: 800,
  height: 500,
  colors: {
    player: '#2979FF',
    playerGlow: 'rgba(41, 121, 255, 0.8)',
    boss: '#FF1744',
    bossGlow: 'rgba(255, 23, 68, 0.8)',
    shield: '#00E5FF',
    shieldGlow: 'rgba(0, 229, 255, 0.8)',
    blood: '#D50000',
    energy: '#FFD700',
    energyGlow: 'rgba(255, 215, 0, 0.8)',
    hypnotized: '#FFFF00',
    hypnotizedGlow: 'rgba(255, 255, 0, 0.8)'
  },
  player: {
    speed: 350,
    size: 32,
    fireRate: 180,
    projectileSpeed: 800,
    damageToBoss: 0.5,
    damageToPlayer: 10
  },
  boss: {
    speed: 150,
    size: 60,
    projectileSpeed: 450,
    fireInterval: 900,
    damageToPlayer: 10,
    damageToBoss: 0.5,
    shieldTriggerPct: 50,
    shieldDamagePerHit: 0.2
  },
  energy: {
    maxHits: 100,
    springDuration: 5000,
    homingSpeed: 600,
    activationKey: 'KeyQ'
  }
};

// ==============================
// CONFIGURACI√ìN POR NIVELES
// ==============================
const LEVEL_CONFIGS = {
  1: { name: "Tutorial", difficulty: "F√°cil", bossHp: 100, bossDamage: 10, bossSpeed: 1.0, projectileSpeed: 1.0, projectileSize: 1.0 },
  2: { name: "Principiante", difficulty: "F√°cil", bossHp: 120, bossDamage: 12, bossSpeed: 1.1, projectileSpeed: 1.1, projectileSize: 1.0 },
  3: { name: "Aprendiz", difficulty: "F√°cil", bossHp: 150, bossDamage: 14, bossSpeed: 1.2, projectileSpeed: 1.2, projectileSize: 1.1 },
  4: { name: "Guerrero", difficulty: "Medio", bossHp: 200, bossDamage: 16, bossSpeed: 1.3, projectileSpeed: 1.3, projectileSize: 1.1 },
  5: { name: "Experto", difficulty: "Medio", bossHp: 250, bossDamage: 18, bossSpeed: 1.4, projectileSpeed: 1.4, projectileSize: 1.2 },
  6: { name: "Maestro", difficulty: "Medio", bossHp: 300, bossDamage: 20, bossSpeed: 1.5, projectileSpeed: 1.5, projectileSize: 1.2 },
  7: { name: "√âlite", difficulty: "Dif√≠cil", bossHp: 350, bossDamage: 22, bossSpeed: 1.6, projectileSpeed: 1.6, projectileSize: 1.3 },
  8: { name: "Legendario", difficulty: "Dif√≠cil", bossHp: 400, bossDamage: 24, bossSpeed: 1.7, projectileSpeed: 1.7, projectileSize: 1.3 },
  9: { name: "M√≠tico", difficulty: "Dif√≠cil", bossHp: 450, bossDamage: 26, bossSpeed: 1.8, projectileSpeed: 1.8, projectileSize: 1.4 },
  10: { name: "Supremo", difficulty: "Extremo", bossHp: 500, bossDamage: 30, bossSpeed: 2.0, projectileSpeed: 2.0, projectileSize: 1.5 }
};

// ==============================
// VARIABLES GLOBALES
// ==============================
let CURRENT_MODE = 'normal';
let CURRENT_DIFFICULTY = 'medium';
let CURRENT_LEVEL = 1;
let CURRENT_VERSION = 'pc'; // 'pc' o 'mobile'
let GAME_ACTIVE = false;
let ANIMATION_FRAME_ID = null;
let GAME_STATE = null;

// ==============================
// SISTEMA DE INPUT PARA PC
// ==============================
const Input = {
  keys: {},
  init() {
    window.removeEventListener('keydown', this.keydownHandler);
    window.removeEventListener('keyup', this.keyupHandler);
    
    this.keydownHandler = (e) => {
      this.keys[e.code] = true;
      
      if (['Space', 'KeyW', 'KeyA', 'KeyS', 'KeyD', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'KeyQ', 'KeyE'].includes(e.code)) {
        e.preventDefault();
      }
    };
    
    this.keyupHandler = (e) => {
      this.keys[e.code] = false;
    };
    
    window.addEventListener('keydown', this.keydownHandler);
    window.addEventListener('keyup', this.keyupHandler);
  },
  isDown(code) { return !!this.keys[code]; },
  clear() { this.keys = {}; },
  destroy() {
    window.removeEventListener('keydown', this.keydownHandler);
    window.removeEventListener('keyup', this.keyupHandler);
  }
};

// ==============================
// SISTEMA DE CONTROLES T√ÅCTILES
// ==============================
const TouchControls = {
  joystickActive: false,
  joystickX: 0,
  joystickY: 0,
  shootPressed: false,
  springPressed: false,
  shieldPressed: false,
  lastShootTime: 0,
  lastSpringTime: 0,
  lastShieldTime: 0,
  
  init() {
    const joystickHandle = document.getElementById('joystickHandle');
    const joystickArea = document.querySelector('.joystick-area');
    
    // Eventos t√°ctiles para el joystick
    joystickArea.addEventListener('touchstart', (e) => {
      this.joystickActive = true;
      this.updateJoystick(e);
      e.preventDefault();
    }, {passive: false});
    
    joystickArea.addEventListener('touchmove', (e) => {
      if (this.joystickActive) {
        this.updateJoystick(e);
        e.preventDefault();
      }
    }, {passive: false});
    
    joystickArea.addEventListener('touchend', (e) => {
      this.joystickActive = false;
      this.joystickX = 0;
      this.joystickY = 0;
      joystickHandle.style.transform = 'translate(-50%, -50%)';
      e.preventDefault();
    }, {passive: false});
    
    // Botones t√°ctiles
    document.getElementById('mobileShootButton').addEventListener('touchstart', (e) => {
      this.shootPressed = true;
      this.lastShootTime = Date.now();
      e.preventDefault();
    }, {passive: false});
    
    document.getElementById('mobileShootButton').addEventListener('touchend', (e) => {
      this.shootPressed = false;
      e.preventDefault();
    }, {passive: false});
    
    document.getElementById('mobileSpringButton').addEventListener('touchstart', (e) => {
      this.springPressed = true;
      this.lastSpringTime = Date.now();
      e.preventDefault();
    }, {passive: false});
    
    document.getElementById('mobileSpringButton').addEventListener('touchend', (e) => {
      this.springPressed = false;
      e.preventDefault();
    }, {passive: false});
    
    document.getElementById('mobileShieldButton').addEventListener('touchstart', (e) => {
      this.shieldPressed = true;
      this.lastShieldTime = Date.now();
      e.preventDefault();
    }, {passive: false});
    
    document.getElementById('mobileShieldButton').addEventListener('touchend', (e) => {
      this.shieldPressed = false;
      e.preventDefault();
    }, {passive: false});
    
    // Prevenir gestos t√°ctiles por defecto
    document.addEventListener('touchmove', (e) => {
      if (e.target.closest('#mobileControls')) {
        e.preventDefault();
      }
    }, {passive: false});
  },
  
  updateJoystick(e) {
    const touch = e.touches[0];
    const joystickArea = document.querySelector('.joystick-area');
    const joystickHandle = document.getElementById('joystickHandle');
    
    const rect = joystickArea.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    
    let deltaX = touch.clientX - centerX;
    let deltaY = touch.clientY - centerY;
    
    // Limitar el joystick a un radio de 50px
    const maxRadius = 50;
    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
    
    if (distance > maxRadius) {
      deltaX = (deltaX / distance) * maxRadius;
      deltaY = (deltaY / distance) * maxRadius;
    }
    
    // Actualizar posici√≥n visual del joystick
    joystickHandle.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
    
    // Normalizar valores entre -1 y 1
    this.joystickX = deltaX / maxRadius;
    this.joystickY = deltaY / maxRadius;
  },
  
  updateForMode(mode) {
    // Cambiar color del joystick seg√∫n el modo
    const joystickHandle = document.getElementById('joystickHandle');
    if (mode === 'normal') {
      joystickHandle.classList.remove('boss');
      joystickHandle.style.background = 'linear-gradient(135deg, var(--player-color), var(--player-color-dark))';
    } else {
      joystickHandle.classList.add('boss');
      joystickHandle.style.background = 'linear-gradient(135deg, var(--boss-color), var(--boss-color-dark))';
    }
  },
  
  clear() {
    this.joystickActive = false;
    this.joystickX = 0;
    this.joystickY = 0;
    this.shootPressed = false;
    this.springPressed = false;
    this.shieldPressed = false;
  }
};

// ==============================
// UTILIDADES
// ==============================
const Utils = {
  clamp(v, min, max) { return Math.max(min, Math.min(max, v)); },
  rectIntersect(r1, r2) {
    return !(r2.x > r1.x + r1.w || r2.x + r2.w < r1.x || r2.y > r1.y + r1.h || r2.y + r2.h < r1.y);
  },
  getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  },
  rgbToHex(r, g, b) {
    return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
  },
  hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16)
    } : null;
  },
  distance(x1, y1, x2, y2) {
    return Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
  },
  // Ajustar color (oscurecer o aclarar)
  adjustColor(hex, amount) {
    let r = parseInt(hex.slice(1,3), 16);
    let g = parseInt(hex.slice(3,5), 16);
    let b = parseInt(hex.slice(5,7), 16);
    
    r = Math.max(0, Math.min(255, r + amount));
    g = Math.max(0, Math.min(255, g + amount));
    b = Math.max(0, Math.min(255, b + amount));
    
    return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
  }
};

// ==============================
// SISTEMA DE PART√çCULAS
// ==============================
class Particle {
  constructor(x, y, color, type = 'spark') {
    this.x = x;
    this.y = y;
    this.color = color;
    this.type = type;
    this.life = 1.0;

    if (this.type === 'spark') {
      const angle = Math.random() * Math.PI * 2;
      const vel = Math.random() * 120 + 50;
      this.vx = Math.cos(angle) * vel;
      this.vy = Math.sin(angle) * vel;
      this.decay = Math.random() * 0.03 + 0.02;
      this.gravity = 0;
      this.size = 2.5;
    } else if (this.type === 'blood') {
      this.vx = (Math.random() - 0.5) * 40; 
      this.vy = Math.random() * 50 + 50;
      this.decay = Math.random() * 0.01 + 0.01;
      this.gravity = 200;
      this.size = Math.random() * 3 + 1;
    }
  }

  update(dt) {
    this.vy += this.gravity * dt;
    this.x += this.vx * dt;
    this.y += this.vy * dt;
    this.life -= this.decay;
  }

  draw(ctx) {
    ctx.globalAlpha = Utils.clamp(this.life, 0, 1);
    ctx.fillStyle = this.color;
    
    ctx.beginPath();
    if(this.type === 'blood') {
      ctx.ellipse(this.x, this.y, this.size, this.size * 1.5, 0, 0, Math.PI*2);
    } else {
      ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
    }
    ctx.fill();
    ctx.globalAlpha = 1;
  }
}

// ==============================
// PROYECTILES - CORREGIDOS CON MEC√ÅNICA DE RESORTE
// ==============================
class Projectile {
  constructor(x, y, vx, vy, owner, color, sizeMultiplier = 1.0) {
    this.x = x;
    this.y = y;
    this.w = 8 * sizeMultiplier;
    this.h = 8 * sizeMultiplier;
    this.vx = vx;
    this.vy = vy;
    this.owner = owner; 
    this.color = color;
    this.trail = [];
    this.bounced = false; 
    this.sizeMultiplier = sizeMultiplier;
    
    // Propiedades para proyectiles hipnotizados
    this.hypnotized = false;
    this.homingTarget = null;
    this.homingSpeed = CONFIG.energy.homingSpeed;
    this.glowIntensity = 0;
    this.hitSomething = false;
  }

  update(dt, target = null) {
    this.trail.push({x: this.x, y: this.y});
    if(this.trail.length > 8) this.trail.shift();

    // Comportamiento de proyectil hipnotizado - SEGUIMIENTO PERFECTO AL JEFE
    if (this.hypnotized && target && target.hp > 0) {
      const targetCenterX = target.x + target.w/2;
      const targetCenterY = target.y + target.h/2;
      const projectileCenterX = this.x + this.w/2;
      const projectileCenterY = this.y + this.h/2;
      
      const dx = targetCenterX - projectileCenterX;
      const dy = targetCenterY - projectileCenterY;
      const dist = Math.sqrt(dx * dx + dy * dy);
      
      // Seguimiento im√°n - velocidad constante hacia el objetivo
      if (dist > 5) {
        const speed = this.homingSpeed * dt;
        this.vx = (dx / dist) * speed;
        this.vy = (dy / dist) * speed;
      } else {
        // Cuando est√° muy cerca, mantener velocidad para asegurar impacto
        this.vx = (dx / Math.max(dist, 1)) * this.homingSpeed * dt;
        this.vy = (dy / Math.max(dist, 1)) * this.homingSpeed * dt;
      }
      
      this.glowIntensity = 0.5 + Math.sin(Date.now() * 0.01) * 0.5;
    }

    // Movimiento normal
    this.x += this.vx * dt;
    this.y += this.vy * dt;
    
    // Rebote en bordes (solo para proyectiles no hipnotizados)
    if (!this.hypnotized) {
      if (this.x <= 0) {
        this.x = 0;
        this.vx = Math.abs(this.vx) * 0.8;
        this.bounced = true;
      } else if (this.x + this.w >= CONFIG.width) {
        this.x = CONFIG.width - this.w;
        this.vx = -Math.abs(this.vx) * 0.8;
        this.bounced = true;
      }
      
      if (this.y <= 0) {
        this.y = 0;
        this.vy = Math.abs(this.vy) * 0.8;
        this.bounced = true;
      } else if (this.y + this.h >= CONFIG.height) {
        this.y = CONFIG.height - this.h;
        this.vy = -Math.abs(this.vy) * 0.8;
        this.bounced = true;
      }
    }
  }

  draw(ctx) {
    // Dibujar estela
    ctx.beginPath();
    this.trail.forEach((pos, i) => {
      const alpha = (i / this.trail.length) * 0.6;
      ctx.fillStyle = this.hypnotized ? CONFIG.colors.hypnotized : this.color;
      ctx.globalAlpha = alpha;
      const size = this.w * (i / this.trail.length);
      const offset = (this.w - size) / 2;
      ctx.fillRect(pos.x + offset, pos.y + offset, size, size);
    });
    ctx.globalAlpha = 1;

    // Dibujar proyectil
    if (this.hypnotized) {
      ctx.shadowBlur = 15 * this.sizeMultiplier + this.glowIntensity * 20;
      ctx.shadowColor = CONFIG.colors.hypnotizedGlow;
      ctx.fillStyle = "#FFFF00";
    } else {
      ctx.shadowBlur = 15 * this.sizeMultiplier;
      ctx.shadowColor = this.color;
      ctx.fillStyle = "#FFF";
    }
    
    ctx.beginPath();
    ctx.roundRect(this.x, this.y, this.w, this.h, 2 * this.sizeMultiplier);
    ctx.fill();
    ctx.shadowBlur = 0;
  }
  
  hypnotize(target) {
    this.hypnotized = true;
    this.owner = 'hypnotized';
    this.color = CONFIG.colors.hypnotized;
    this.homingTarget = target;
    // Aumentar velocidad cuando se hipnotiza
    const currentSpeed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
    const speedMultiplier = this.homingSpeed / Math.max(currentSpeed, 1);
    this.vx *= speedMultiplier;
    this.vy *= speedMultiplier;
  }
  
  bounceFromShield() {
    this.hypnotized = true;
    this.color = CONFIG.colors.hypnotized;
    // Rebote aleatorio
    this.vx = (Math.random() - 0.5) * 800;
    this.vy = Math.abs(this.vy) * -0.5;
    this.bounced = true;
    this.hitSomething = true;
  }
}

// ==============================
// JUGADOR
// ==============================
class Player {
  constructor(isAI = false) {
    this.w = CONFIG.player.size;
    this.h = CONFIG.player.size;
    this.x = CONFIG.width / 2 - this.w / 2;
    this.y = CONFIG.height - 80;
    this.hp = 100;
    this.lastShot = 0;
    this.animY = 0;
    this.isAI = isAI;
    this.aiDirection = 1;
    this.aiSpeed = CONFIG.player.speed;
    this.aiFireRate = CONFIG.player.fireRate;
    this.aiAccuracy = 0.8;
    this.aiCooldown = 0;
    
    // Sistema de energ√≠a
    this.energyHits = 0;
    this.energyActive = false;
    this.energyEndTime = 0;
    
    // Cargar color personalizado
    const playerColor = Storage.getPlayerColor();
    CONFIG.colors.player = Utils.rgbToHex(playerColor.r, playerColor.g, playerColor.b);
    CONFIG.colors.playerGlow = `rgba(${playerColor.r}, ${playerColor.g}, ${playerColor.b}, 0.8)`;
    
    this.adjustDifficulty();
  }

  adjustDifficulty() {
    if (!this.isAI) return;
    
    switch(CURRENT_DIFFICULTY) {
      case 'easy':
        this.aiSpeed = CONFIG.player.speed * 0.6;
        this.aiFireRate = CONFIG.player.fireRate * 2.0;
        this.aiAccuracy = 0.5;
        break;
      case 'medium':
        this.aiSpeed = CONFIG.player.speed * 0.8;
        this.aiFireRate = CONFIG.player.fireRate * 1.5;
        this.aiAccuracy = 0.7;
        break;
      case 'hard':
        this.aiSpeed = CONFIG.player.speed;
        this.aiFireRate = CONFIG.player.fireRate;
        this.aiAccuracy = 0.8;
        break;
      case 'extreme':
        this.aiSpeed = CONFIG.player.speed * 1.2;
        this.aiFireRate = CONFIG.player.fireRate * 0.8;
        this.aiAccuracy = 0.9;
        break;
      case 'impossible':
        this.aiSpeed = CONFIG.player.speed * 1.5;
        this.aiFireRate = CONFIG.player.fireRate * 0.6;
        this.aiAccuracy = 1.0;
        break;
    }
  }
  
  addEnergy() {
    if (!this.energyActive && this.energyHits < CONFIG.energy.maxHits) {
      this.energyHits++;
      this.updateEnergyUI();
      return true;
    }
    return false;
  }
  
  updateEnergyUI() {
    const energyBar = document.getElementById('energyBar');
    const energyText = document.getElementById('energyText');
    const energyPercent = (this.energyHits / CONFIG.energy.maxHits) * 100;
    
    if (energyBar) {
      energyBar.style.width = `${energyPercent}%`;
      energyText.textContent = `${this.energyHits}/${CONFIG.energy.maxHits}`;
    }
  }
  
  canActivateSpring() {
    return !this.energyActive && this.energyHits >= CONFIG.energy.maxHits;
  }
  
  activateSpring() {
    if (!this.canActivateSpring()) return false;
    
    this.energyActive = true;
    this.energyEndTime = performance.now() + CONFIG.energy.springDuration;
    this.energyHits = 0;
    
    // Crear aura visual mejorada
    this.createSpringAura();
    
    // Actualizar UI
    this.updateEnergyUI();
    document.getElementById('energyContainer').classList.remove('active');
    
    // Efecto visual de activaci√≥n
    if (GAME_STATE) {
      const emoji = document.createElement('div');
      emoji.className = 'spring-emoji';
      emoji.textContent = '‚ö°';
      emoji.style.left = `${this.x + this.w/2 - 24}px`;
      emoji.style.top = `${this.y - 40}px`;
      document.getElementById('springAura').appendChild(emoji);
      
      setTimeout(() => {
        if (emoji.parentNode) {
          emoji.parentNode.removeChild(emoji);
        }
      }, 1000);
    }
    
    return true;
  }
  
  createSpringAura() {
    const aura = document.getElementById('springAura');
    aura.style.left = `${this.x - 60}px`;
    aura.style.top = `${this.y - 60}px`;
    aura.style.width = `${this.w + 120}px`;
    aura.style.height = `${this.h + 120}px`;
    aura.style.background = 'radial-gradient(circle, rgba(255,215,0,0.8) 0%, rgba(255,215,0,0.3) 50%, transparent 70%)';
    aura.style.border = '4px solid rgba(255, 215, 0, 0.8)';
    aura.classList.add('active');
  }
  
  updateSpring(dt, time) {
    if (this.energyActive && time >= this.energyEndTime) {
      this.energyActive = false;
      document.getElementById('springAura').classList.remove('active');
      document.getElementById('energyContainer').classList.add('active');
    }
    
    // Actualizar posici√≥n del aura
    if (this.energyActive) {
      const aura = document.getElementById('springAura');
      aura.style.left = `${this.x - 60}px`;
      aura.style.top = `${this.y - 60}px`;
    }
  }

  update(dt, time, targetX = null, targetY = null) {
    if (this.isAI) {
      this.updateAI(dt, time, targetX, targetY);
    } else {
      this.updatePlayer(dt, time);
    }

    this.animY = Math.sin(time * 0.005) * 4;

    // Actualizar resorte de energ√≠a
    this.updateSpring(dt, time);

    // EFECTO DE DESANGRADO
    if (this.hp < 40) {
      if (Math.random() < 0.15) {
        GAME_STATE.spawnParticle(
          this.x + Math.random()*this.w, 
          this.y + this.h/2, 
          CONFIG.colors.blood, 
          'blood'
        );
      }
    }
  }

  updatePlayer(dt, time) {
    let vx = 0, vy = 0;
    
    // Controles seg√∫n la versi√≥n
    if (CURRENT_VERSION === 'pc') {
      // Controles PC
      if(Input.isDown('KeyW') || Input.isDown('ArrowUp')) vy = -1;
      if(Input.isDown('KeyS') || Input.isDown('ArrowDown')) vy = 1;
      if(Input.isDown('KeyA') || Input.isDown('ArrowLeft')) vx = -1;
      if(Input.isDown('KeyD') || Input.isDown('ArrowRight')) vx = 1;
    } else {
      // Controles m√≥viles t√°ctiles
      vx = TouchControls.joystickX;
      vy = TouchControls.joystickY;
    }

    if(vx !== 0 && vy !== 0) {
      const invMag = 1 / Math.sqrt(2);
      vx *= invMag; vy *= invMag;
    }

    this.x += vx * CONFIG.player.speed * dt;
    this.y += vy * CONFIG.player.speed * dt;
    this.x = Utils.clamp(this.x, 0, CONFIG.width - this.w);
    this.y = Utils.clamp(this.y, 0, CONFIG.height - this.h);

    // Disparo
    let shouldShoot = false;
    if (CURRENT_VERSION === 'pc') {
      shouldShoot = Input.isDown('Space');
    } else {
      shouldShoot = TouchControls.shootPressed;
    }
    
    if(shouldShoot) {
      if(time - this.lastShot > CONFIG.player.fireRate) {
        GAME_STATE.spawnProjectile(
          this.x + this.w/2 - 4, 
          this.y, 
          0, -CONFIG.player.projectileSpeed, 
          'player', CONFIG.colors.player
        );
        this.lastShot = time;
      }
    }
    
    // Activar resorte de energ√≠a
    let shouldActivateSpring = false;
    if (CURRENT_VERSION === 'pc') {
      shouldActivateSpring = Input.isDown(CONFIG.energy.activationKey);
    } else {
      shouldActivateSpring = TouchControls.springPressed && 
                            (Date.now() - TouchControls.lastSpringTime > 500);
    }
    
    if(shouldActivateSpring && this.canActivateSpring()) {
      this.activateSpring();
      if (CURRENT_VERSION === 'mobile') {
        TouchControls.lastSpringTime = Date.now();
      }
    }
  }

  updateAI(dt, time, targetX, targetY) {
    // Movimiento AI
    this.x += this.aiDirection * this.aiSpeed * dt;
    
    if(this.x <= 20 || this.x + this.w >= CONFIG.width - 20) {
      this.aiDirection *= -1;
      this.aiCooldown = 0.3;
    }
    
    if (this.aiCooldown > 0) {
      this.aiCooldown -= dt;
      return;
    }

    // Disparo AI
    if(targetX !== null && targetY !== null) {
      if(time - this.lastShot > this.aiFireRate) {
        const centerX = this.x + this.w/2;
        const centerY = this.y + this.h/2;
        
        let angle = Math.atan2(targetY - centerY, targetX - centerX);
        
        const spread = (1 - this.aiAccuracy) * 0.3;
        angle += (Math.random() - 0.5) * spread;
        
        const speed = CONFIG.player.projectileSpeed * (0.9 + Math.random() * 0.2);
        const pVx = Math.cos(angle) * speed;
        const pVy = Math.sin(angle) * speed;

        GAME_STATE.spawnProjectile(centerX - 4, centerY, pVx, pVy, 'player', CONFIG.colors.player);
        this.lastShot = time;
      }
    }
  }

  draw(ctx) {
    const drawY = this.y + this.animY;
    
    // Sombra
    ctx.fillStyle = 'rgba(0,0,0,0.15)';
    ctx.beginPath();
    ctx.ellipse(this.x + this.w/2, drawY + this.h + 12, this.w/1.5, 5, 0, 0, Math.PI*2);
    ctx.fill();

    // Cuerpo con color personalizado
    ctx.shadowBlur = 20;
    ctx.shadowColor = this.isAI ? `rgba(${Storage.getPlayerColor().r}, ${Storage.getPlayerColor().g}, ${Storage.getPlayerColor().b}, 0.4)` : CONFIG.colors.playerGlow;
    ctx.fillStyle = CONFIG.colors.player;
    ctx.beginPath();
    ctx.roundRect(this.x, drawY, this.w, this.h, 8);
    ctx.fill();
    ctx.shadowBlur = 0;

    // Detalle "Core"
    ctx.fillStyle = this.isAI ? 'rgba(255,255,255,0.2)' : 'rgba(255,255,255,0.4)';
    ctx.beginPath();
    ctx.arc(this.x + 10, drawY + 10, 4, 0, Math.PI*2);
    ctx.fill();
    
    // Indicador de energ√≠a activa
    if (this.energyActive) {
      ctx.save();
      ctx.strokeStyle = CONFIG.colors.energy;
      ctx.lineWidth = 3;
      ctx.globalAlpha = 0.7;
      ctx.beginPath();
      ctx.arc(this.x + this.w/2, drawY + this.h/2, this.w/2 + 15, 0, Math.PI * 2);
      ctx.stroke();
      
      // Aura interior
      ctx.strokeStyle = '#FFFFFF';
      ctx.lineWidth = 1;
      ctx.globalAlpha = 0.4;
      ctx.beginPath();
      ctx.arc(this.x + this.w/2, drawY + this.h/2, this.w/2 + 18, 0, Math.PI * 2);
      ctx.stroke();
      
      // Puntos de energ√≠a girando
      const angle = Date.now() * 0.002;
      for(let i = 0; i < 8; i++) {
        const a = angle + (i * Math.PI / 4);
        const px = this.x + this.w/2 + Math.cos(a) * (this.w/2 + 20);
        const py = drawY + this.h/2 + Math.sin(a) * (this.w/2 + 20);
        
        ctx.fillStyle = CONFIG.colors.energy;
        ctx.globalAlpha = 0.9;
        ctx.beginPath();
        ctx.arc(px, py, 4, 0, Math.PI * 2);
        ctx.fill();
      }
      ctx.restore();
    }
  }
}

// ==============================
// JEFE
// ==============================
class Boss {
  constructor(isPlayer = false) {
    this.w = CONFIG.boss.size;
    this.h = CONFIG.boss.size;
    this.x = CONFIG.width / 2 - this.w / 2;
    this.y = 60;
    this.hp = 100;
    this.vx = CONFIG.boss.speed;
    this.animY = 0;
    this.lastShot = 0;
    this.isPlayer = isPlayer;
    
    // Cargar color personalizado
    const bossColor = Storage.getBossColor();
    CONFIG.colors.boss = Utils.rgbToHex(bossColor.r, bossColor.g, bossColor.b);
    CONFIG.colors.bossGlow = `rgba(${bossColor.r}, ${bossColor.g}, ${bossColor.b}, 0.8)`;
    
    // Escudo
    this.shieldActive = false;
    this.shieldBroken = false;
    this.shieldHP = 10;
    
    // Configuraci√≥n del nivel (solo modo normal)
    if (!isPlayer && LEVEL_CONFIGS[CURRENT_LEVEL]) {
      const levelConfig = LEVEL_CONFIGS[CURRENT_LEVEL];
      this.hp = levelConfig.bossHp;
    }
  }

  update(dt, time, playerX = null, playerY = null) {
    if (this.isPlayer) {
      this.updatePlayerControl(dt, time, playerX, playerY);
    } else {
      this.updateAI(dt, time, playerX, playerY);
    }

    this.animY = Math.cos(time * 0.003) * 6;

    // EFECTO DESANGRADO
    if (this.hp < 40) {
      if (Math.random() < 0.2) {
        GAME_STATE.spawnParticle(
          this.x + Math.random()*this.w, 
          this.y + this.h, 
          '#880E4F',
          'blood'
        );
      }
    }

    // Control manual del escudo (solo Modo Yo Jefe)
    if (this.isPlayer) {
      let shouldActivateShield = false;
      if (CURRENT_VERSION === 'pc') {
        shouldActivateShield = Input.isDown('KeyQ');
      } else {
        shouldActivateShield = TouchControls.shieldPressed && 
                              (Date.now() - TouchControls.lastShieldTime > 500);
      }
      
      if (shouldActivateShield && this.hp <= 50 && !this.shieldActive && !this.shieldBroken) {
        this.activateShield();
        if (CURRENT_VERSION === 'mobile') {
          TouchControls.lastShieldTime = Date.now();
        }
      }
      
      this.updateShieldButton();
    } else {
      // Activar Escudo autom√°tico al 50%
      if(this.hp <= CONFIG.boss.shieldTriggerPct && !this.shieldActive && !this.shieldBroken) {
        this.activateShield();
      }
    }

    // Ocultar escudo si est√° roto o desactivado
    if((this.shieldBroken || !this.shieldActive) && document.getElementById('shieldContainer').classList.contains('active')) {
      this.deactivateShield();
    }
  }

  updateAI(dt, time, playerX, playerY) {
    const levelConfig = LEVEL_CONFIGS[CURRENT_LEVEL] || LEVEL_CONFIGS[1];
    
    // Movimiento con velocidad del nivel
    this.x += this.vx * dt * levelConfig.bossSpeed;
    if(this.x <= 20 || this.x + this.w >= CONFIG.width - 20) {
      this.vx *= -1;
    }

    // Disparo con configuraci√≥n del nivel
    if(time - this.lastShot > CONFIG.boss.fireInterval / levelConfig.bossSpeed) {
      const centerX = this.x + this.w/2;
      const centerY = this.y + this.h/2;
      const targetX = playerX + 16; 
      const targetY = playerY + 16;
      
      let angle = Math.atan2(targetY - centerY, targetX - centerX);
      
      const spread = 0.15 / (levelConfig.bossSpeed * 0.5);
      angle += (Math.random() - 0.5) * spread;
      
      const projectileSpeed = CONFIG.boss.projectileSpeed * levelConfig.projectileSpeed;
      const pVx = Math.cos(angle) * projectileSpeed;
      const pVy = Math.sin(angle) * projectileSpeed;

      GAME_STATE.spawnProjectile(
        centerX - 4, 
        centerY + this.h/2, 
        pVx, pVy, 
        'boss', 
        CONFIG.colors.boss,
        levelConfig.projectileSize
      );
      this.lastShot = time;
    }
  }

  updatePlayerControl(dt, time, playerX, playerY) {
    // Aumentar velocidad de movimiento en modo Yo Jefe
    const moveSpeed = CONFIG.boss.speed * 2.0;
    const fireInterval = CONFIG.boss.fireInterval * 0.4;

    // Movimiento horizontal
    let moveDirection = 0;
    if (CURRENT_VERSION === 'pc') {
      if (Input.isDown('KeyA') || Input.isDown('ArrowLeft')) {
        moveDirection = -1;
      }
      if (Input.isDown('KeyD') || Input.isDown('ArrowRight')) {
        moveDirection = 1;
      }
    } else {
      // Controles m√≥viles
      moveDirection = TouchControls.joystickX;
    }
    
    this.x += moveDirection * moveSpeed * dt;
    this.x = Utils.clamp(this.x, 0, CONFIG.width - this.w);

    // Disparo
    let shouldShoot = false;
    if (CURRENT_VERSION === 'pc') {
      shouldShoot = Input.isDown('Space');
    } else {
      shouldShoot = TouchControls.shootPressed;
    }
    
    if (shouldShoot) {
      if (time - this.lastShot > fireInterval) {
        GAME_STATE.spawnProjectile(
          this.x + this.w/2 - 4,
          this.y + this.h/2,
          0, CONFIG.boss.projectileSpeed,
          'boss', CONFIG.colors.boss
        );
        this.lastShot = time;
      }
    }
  }

  updateShieldButton() {
    const button = document.getElementById('shieldManualButton');
    const container = document.getElementById('shieldButtonContainer');
    const mobileShieldButton = document.getElementById('mobileShieldButton');
    
    if (this.hp <= 50 && !this.shieldActive && !this.shieldBroken) {
      button.disabled = false;
      button.textContent = 'ACTIVAR ESCUDO (Tecla Q)';
      container.classList.add('active');
      if (CURRENT_VERSION === 'mobile') {
        mobileShieldButton.style.display = 'flex';
      }
    } else if (this.shieldActive) {
      button.disabled = true;
      button.textContent = 'ESCUDO ACTIVADO';
      container.classList.add('active');
      if (CURRENT_VERSION === 'mobile') {
        mobileShieldButton.style.display = 'flex';
      }
    } else if (this.shieldBroken) {
      button.disabled = true;
      button.textContent = 'ESCUDO DESTRUIDO';
      container.classList.add('active');
      if (CURRENT_VERSION === 'mobile') {
        mobileShieldButton.style.display = 'flex';
      }
    } else {
      container.classList.remove('active');
      if (CURRENT_VERSION === 'mobile') {
        mobileShieldButton.style.display = 'none';
      }
    }
  }

  activateShield() {
    this.shieldActive = true;
    this.shieldBroken = false;
    this.shieldHP = 10;
    document.getElementById('shieldContainer').classList.add('active');
    
    // Efecto visual
    for(let i=0; i<15; i++) {
      GAME_STATE.spawnParticle(this.x + this.w/2, this.y + this.h/2, CONFIG.colors.shield, 'spark');
    }
  }

  deactivateShield() {
    this.shieldActive = false;
    document.getElementById('shieldContainer').classList.remove('active');
  }

  takeShieldDamage() {
    this.shieldHP -= CONFIG.boss.shieldDamagePerHit;
    
    if(this.shieldHP <= 0) {
      this.shieldHP = 0;
      this.breakShield();
    }
  }

  breakShield() {
    this.shieldActive = false;
    this.shieldBroken = true;
    document.getElementById('shieldContainer').classList.remove('active');
    
    // Explosi√≥n del escudo
    for(let i=0; i<50; i++) {
      GAME_STATE.spawnParticle(this.x + this.w/2, this.y + this.h/2, CONFIG.colors.shield, 'spark');
    }
  }

  draw(ctx) {
    const drawY = this.y + this.animY;

    // Sombra
    ctx.fillStyle = 'rgba(0,0,0,0.2)';
    ctx.beginPath();
    ctx.ellipse(this.x + this.w/2, drawY + this.h + 18, this.w, 8, 0, 0, Math.PI*2);
    ctx.fill();

    // Cubo Jefe con color personalizado
    ctx.shadowBlur = 25;
    ctx.shadowColor = CONFIG.colors.bossGlow;
    ctx.fillStyle = CONFIG.colors.boss;
    ctx.beginPath();
    ctx.roundRect(this.x, drawY, this.w, this.h, 12);
    ctx.fill();
    ctx.shadowBlur = 0;

    // Cara Enojada
    ctx.fillStyle = '#FFF';
    ctx.beginPath();
    ctx.moveTo(this.x + 12, drawY + 20);
    ctx.lineTo(this.x + 28, drawY + 28);
    ctx.lineTo(this.x + 12, drawY + 35);
    ctx.fill();
    ctx.beginPath();
    ctx.moveTo(this.x + this.w - 12, drawY + 20);
    ctx.lineTo(this.x + this.w - 28, drawY + 28);
    ctx.lineTo(this.x + this.w - 12, drawY + 35);
    ctx.fill();

    // ESCUDO (visual)
    if(this.shieldActive) {
      // Emoji Gigante
      ctx.font = "48px Arial";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      const scale = 1 + Math.sin(performance.now() * 0.008) * 0.05;
      
      ctx.save();
      ctx.translate(this.x + this.w/2, drawY + this.h + 20);
      ctx.scale(scale, scale);
      ctx.fillText("üõ°Ô∏è", 0, 0);
      ctx.restore();

      // Aura de fuerza
      ctx.save();
      ctx.translate(this.x + this.w/2, drawY + this.h/2);
      ctx.rotate(performance.now() * 0.001);
      ctx.strokeStyle = `rgba(0, 229, 255, 0.4)`;
      ctx.lineWidth = 2;
      ctx.beginPath();
      for(let i=0; i<6; i++) {
        ctx.lineTo(45 * Math.cos(i * Math.PI / 3), 45 * Math.sin(i * Math.PI / 3));
      }
      ctx.closePath();
      ctx.stroke();
      ctx.restore();
    }
  }
}

// ==============================
// ESTADO PRINCIPAL DEL JUEGO
// ==============================
class GameState {
  constructor() {
    this.canvas = document.getElementById('gameCanvas');
    this.ctx = this.canvas.getContext('2d');
    this.lastTime = 0;
    this.projectiles = [];
    this.particles = [];
    this.player = null;
    this.boss = null;
    this.running = false;
    this.animationId = null;
    this.victory = false;
    this.gameOver = false;
    this.hypnotizedProjectiles = [];
  }

  init() {
    // Inicializar almacenamiento
    Storage.init();
    Storage.updateCSSColors();
    
    // Cargar versi√≥n seleccionada
    CURRENT_VERSION = Storage.getSelectedVersion();
    
    // Configurar men√∫s
    this.setupMenus();
    
    // Inicializar input seg√∫n versi√≥n
    if (CURRENT_VERSION === 'pc') {
      Input.init();
    } else {
      TouchControls.init();
    }
  }

  updateColorsFromStorage() {
    const playerColor = Storage.getPlayerColor();
    const bossColor = Storage.getBossColor();
    
    // Actualizar configuraciones
    CONFIG.colors.player = Utils.rgbToHex(playerColor.r, playerColor.g, playerColor.b);
    CONFIG.colors.playerGlow = `rgba(${playerColor.r}, ${playerColor.g}, ${playerColor.b}, 0.8)`;
    CONFIG.colors.boss = Utils.rgbToHex(bossColor.r, bossColor.g, bossColor.b);
    CONFIG.colors.bossGlow = `rgba(${bossColor.r}, ${bossColor.g}, ${bossColor.b}, 0.8)`;
    
    // Actualizar vistas previas
    document.getElementById('playerColorPreview').style.background = CONFIG.colors.player;
    document.getElementById('bossColorPreview').style.background = CONFIG.colors.boss;
    
    // Actualizar controles RGB
    document.getElementById('playerRed').value = playerColor.r;
    document.getElementById('playerGreen').value = playerColor.g;
    document.getElementById('playerBlue').value = playerColor.b;
    document.getElementById('playerRedValue').textContent = playerColor.r;
    document.getElementById('playerGreenValue').textContent = playerColor.g;
    document.getElementById('playerBlueValue').textContent = playerColor.b;
    
    document.getElementById('bossRed').value = bossColor.r;
    document.getElementById('bossGreen').value = bossColor.g;
    document.getElementById('bossBlue').value = bossColor.b;
    document.getElementById('bossRedValue').textContent = bossColor.r;
    document.getElementById('bossGreenValue').textContent = bossColor.g;
    document.getElementById('bossBlueValue').textContent = bossColor.b;
  }

  setupMenus() {
    // Botones de versi√≥n
    document.getElementById('versionPC').addEventListener('click', () => {
      CURRENT_VERSION = 'pc';
      Storage.saveSelectedVersion('pc');
      this.updateVersionUI();
    });
    
    document.getElementById('versionMobile').addEventListener('click', () => {
      CURRENT_VERSION = 'mobile';
      Storage.saveSelectedVersion('mobile');
      this.updateVersionUI();
    });
    
    // Actualizar UI de versi√≥n
    this.updateVersionUI();
    
    // Bot√≥n Modo Normal
    document.getElementById('startButton').addEventListener('click', () => {
      this.showLevelMenu();
    });
    
    // Bot√≥n Modo Yo Jefe
    document.getElementById('bossModeButton').addEventListener('click', () => {
      this.showDifficultyMenu();
    });
    
    // Bot√≥n Personalizar Colores
    document.getElementById('colorCustomizeButton').addEventListener('click', () => {
      this.showColorMenu();
    });
    
    // Bot√≥n Borrar Progreso
    document.getElementById('deleteProgressButton').addEventListener('click', () => {
      this.showDeleteProgressMenu();
    });
    
    // Configurar men√∫ de borrar progreso
    this.setupDeleteProgressMenu();
    
    // Bot√≥n Volver desde Dificultad
    document.getElementById('backFromDifficulty').addEventListener('click', () => {
      this.hideDifficultyMenu();
    });
    
    // Bot√≥n Volver desde Niveles
    document.getElementById('backFromLevels').addEventListener('click', () => {
      this.hideLevelMenu();
    });
    
    // Bot√≥n Volver desde Colores
    document.getElementById('backFromColors').addEventListener('click', () => {
      this.hideColorMenu();
    });
    
    // Bot√≥n Guardar Colores
    document.getElementById('saveColors').addEventListener('click', () => {
      this.saveColors();
    });
    
    // Configurar controles RGB
    this.setupColorControls();
    
    // Generar niveles
    this.generateLevels();
    
    // Configurar botones de dificultad
    document.querySelectorAll('.difficulty-button').forEach(button => {
      button.addEventListener('click', (e) => {
        const difficulty = e.target.dataset.difficulty;
        this.startBossGame(difficulty);
      });
    });
    
    // Bot√≥n manual del escudo
    document.getElementById('shieldManualButton').addEventListener('click', () => {
      if (this.boss && this.boss.isPlayer && this.boss.hp <= 50 && !this.boss.shieldActive && !this.boss.shieldBroken) {
        this.boss.activateShield();
      }
    });
  }
  
  updateVersionUI() {
    const pcButton = document.getElementById('versionPC');
    const mobileButton = document.getElementById('versionMobile');
    
    if (CURRENT_VERSION === 'pc') {
      pcButton.style.transform = 'scale(1.05)';
      pcButton.style.boxShadow = '0 15px 35px rgba(41, 121, 255, 0.6)';
      mobileButton.style.transform = 'scale(1)';
      mobileButton.style.boxShadow = '0 10px 30px rgba(76, 175, 80, 0.4)';
    } else {
      pcButton.style.transform = 'scale(1)';
      pcButton.style.boxShadow = '0 10px 30px rgba(41, 121, 255, 0.4)';
      mobileButton.style.transform = 'scale(1.05)';
      mobileButton.style.boxShadow = '0 15px 35px rgba(76, 175, 80, 0.6)';
    }
  }

  setupDeleteProgressMenu() {
    const confirmCheckbox = document.getElementById('confirmDeleteCheckbox');
    const confirmButton = document.getElementById('confirmDeleteButton');
    const cancelButton = document.getElementById('cancelDeleteButton');
    
    // Inicializar bot√≥n desactivado
    confirmButton.disabled = true;
    confirmButton.style.opacity = '0.5';
    confirmButton.style.cursor = 'not-allowed';
    
    // Checkbox de confirmaci√≥n
    confirmCheckbox.addEventListener('change', () => {
      if (confirmCheckbox.checked) {
        confirmButton.disabled = false;
        confirmButton.style.opacity = '1';
        confirmButton.style.cursor = 'pointer';
      } else {
        confirmButton.disabled = true;
        confirmButton.style.opacity = '0.5';
        confirmButton.style.cursor = 'not-allowed';
      }
    });
    
    // Bot√≥n Cancelar
    cancelButton.addEventListener('click', () => {
      this.hideDeleteProgressMenu();
    });
    
    // Bot√≥n Borrar Confirmado
    confirmButton.addEventListener('click', () => {
      if (confirmCheckbox.checked) {
        this.deleteAllProgress();
      }
    });
  }
  
  showDeleteProgressMenu() {
    document.getElementById('mainMenu').style.display = 'none';
    document.getElementById('deleteProgressMenu').style.display = 'flex';
    
    // Resetear checkbox y bot√≥n
    document.getElementById('confirmDeleteCheckbox').checked = false;
    document.getElementById('confirmDeleteButton').disabled = true;
    document.getElementById('confirmDeleteButton').style.opacity = '0.5';
    document.getElementById('confirmDeleteButton').style.cursor = 'not-allowed';
  }
  
  hideDeleteProgressMenu() {
    document.getElementById('deleteProgressMenu').style.display = 'none';
    document.getElementById('mainMenu').style.display = 'flex';
  }
  
  deleteAllProgress() {
    // Borrar de localStorage
    Storage.deleteAllProgress();
    
    // Actualizar colores en el juego
    this.updateColorsFromStorage();
    
    // Regenerar niveles
    this.generateLevels();
    
    // Ocultar men√∫ y mostrar mensaje
    this.hideDeleteProgressMenu();
    
    // Mostrar alerta de confirmaci√≥n
    setTimeout(() => {
      alert('‚úÖ Progreso borrado correctamente.\nLos niveles y colores han sido restablecidos.');
    }, 300);
  }

  setupColorControls() {
    // Controladores para el jugador
    document.getElementById('playerRed').addEventListener('input', (e) => {
      const value = e.target.value;
      document.getElementById('playerRedValue').textContent = value;
      this.updatePlayerColorPreview();
    });
    
    document.getElementById('playerGreen').addEventListener('input', (e) => {
      const value = e.target.value;
      document.getElementById('playerGreenValue').textContent = value;
      this.updatePlayerColorPreview();
    });
    
    document.getElementById('playerBlue').addEventListener('input', (e) => {
      const value = e.target.value;
      document.getElementById('playerBlueValue').textContent = value;
      this.updatePlayerColorPreview();
    });
    
    // Controladores para el jefe
    document.getElementById('bossRed').addEventListener('input', (e) => {
      const value = e.target.value;
      document.getElementById('bossRedValue').textContent = value;
      this.updateBossColorPreview();
    });
    
    document.getElementById('bossGreen').addEventListener('input', (e) => {
      const value = e.target.value;
      document.getElementById('bossGreenValue').textContent = value;
      this.updateBossColorPreview();
    });
    
    document.getElementById('bossBlue').addEventListener('input', (e) => {
      const value = e.target.value;
      document.getElementById('bossBlueValue').textContent = value;
      this.updateBossColorPreview();
    });
  }

  updatePlayerColorPreview() {
    const r = document.getElementById('playerRed').value;
    const g = document.getElementById('playerGreen').value;
    const b = document.getElementById('playerBlue').value;
    document.getElementById('playerColorPreview').style.background = `rgb(${r}, ${g}, ${b})`;
  }

  updateBossColorPreview() {
    const r = document.getElementById('bossRed').value;
    const g = document.getElementById('bossGreen').value;
    const b = document.getElementById('bossBlue').value;
    document.getElementById('bossColorPreview').style.background = `rgb(${r}, ${g}, ${b})`;
  }

  saveColors() {
    const playerR = parseInt(document.getElementById('playerRed').value);
    const playerG = parseInt(document.getElementById('playerGreen').value);
    const playerB = parseInt(document.getElementById('playerBlue').value);
    
    const bossR = parseInt(document.getElementById('bossRed').value);
    const bossG = parseInt(document.getElementById('bossGreen').value);
    const bossB = parseInt(document.getElementById('bossBlue').value);
    
    Storage.savePlayerColor(playerR, playerG, playerB);
    Storage.saveBossColor(bossR, bossG, bossB);
    
    // Actualizar colores en el juego actual
    this.updateColorsFromStorage();
    
    // Mostrar mensaje de confirmaci√≥n
    alert('‚úÖ ¬°Colores guardados correctamente!\nLas barras de vida ahora coinciden con tus colores personalizados.');
  }

  generateLevels() {
    const levelsGrid = document.getElementById('levelsGrid');
    levelsGrid.innerHTML = '';
    
    const unlockedLevels = Storage.getUnlockedLevels();
    
    for (let i = 1; i <= 10; i++) {
      const levelConfig = LEVEL_CONFIGS[i];
      const isUnlocked = unlockedLevels.includes(i);
      
      const levelButton = document.createElement('button');
      levelButton.className = `level-button ${isUnlocked ? 'unlocked' : 'locked'}`;
      levelButton.dataset.level = i;
      
      levelButton.innerHTML = `
        <div class="level-number">${i}</div>
        <div class="level-difficulty">${levelConfig.difficulty}</div>
        ${!isUnlocked ? '<div class="lock-icon">üîí</div>' : ''}
      `;
      
      if (isUnlocked) {
        levelButton.addEventListener('click', () => {
          this.startNormalGame(i);
        });
      }
      
      levelsGrid.appendChild(levelButton);
    }
  }

  showDifficultyMenu() {
    document.getElementById('mainMenu').style.display = 'none';
    document.getElementById('difficultyMenu').style.display = 'flex';
  }

  hideDifficultyMenu() {
    document.getElementById('difficultyMenu').style.display = 'none';
    document.getElementById('mainMenu').style.display = 'flex';
  }

  showLevelMenu() {
    this.generateLevels();
    document.getElementById('mainMenu').style.display = 'none';
    document.getElementById('levelMenu').style.display = 'flex';
  }

  hideLevelMenu() {
    document.getElementById('levelMenu').style.display = 'none';
    document.getElementById('mainMenu').style.display = 'flex';
  }

  showColorMenu() {
    document.getElementById('mainMenu').style.display = 'none';
    document.getElementById('colorMenu').style.display = 'flex';
  }

  hideColorMenu() {
    document.getElementById('colorMenu').style.display = 'none';
    document.getElementById('mainMenu').style.display = 'flex';
  }

  startNormalGame(level) {
    CURRENT_MODE = 'normal';
    CURRENT_LEVEL = level;
    this.startGame();
  }

  startBossGame(difficulty) {
    CURRENT_MODE = 'boss';
    CURRENT_DIFFICULTY = difficulty;
    this.startGame();
  }

  startGame() {
    // Ocultar todos los men√∫s
    document.getElementById('mainMenu').style.display = 'none';
    document.getElementById('difficultyMenu').style.display = 'none';
    document.getElementById('levelMenu').style.display = 'none';
    document.getElementById('colorMenu').style.display = 'none';
    document.getElementById('deleteProgressMenu').style.display = 'none';
    
    // Mostrar juego
    document.getElementById('gameWrapper').style.display = 'flex';
    
    // Mostrar/ocultar controles m√≥viles seg√∫n versi√≥n
    const mobileControls = document.getElementById('mobileControls');
    if (CURRENT_VERSION === 'mobile') {
      mobileControls.classList.add('active');
      TouchControls.updateForMode(CURRENT_MODE);
      
      // Mostrar botones correctos seg√∫n modo
      const springButton = document.getElementById('mobileSpringButton');
      const shieldButton = document.getElementById('mobileShieldButton');
      
      if (CURRENT_MODE === 'normal') {
        springButton.style.display = 'flex';
        shieldButton.style.display = 'none';
      } else {
        springButton.style.display = 'none';
        shieldButton.style.display = 'flex';
      }
    } else {
      mobileControls.classList.remove('active');
    }
    
    // Configurar interfaz seg√∫n modo
    if (CURRENT_MODE === 'normal') {
      document.getElementById('modeIndicator').className = 'mode-normal';
      document.getElementById('modeIndicator').innerHTML = `
        <div>MODO NORMAL</div>
        <div class="level-indicator">NIVEL ${CURRENT_LEVEL}</div>
      `;
      document.getElementById('normalControls').style.display = 'block';
      document.getElementById('bossControls').style.display = 'none';
      document.getElementById('energyContainer').classList.add('active');
      document.getElementById('energyRequirement').style.display = 'block';
    } else {
      document.getElementById('modeIndicator').className = 'mode-boss';
      document.getElementById('modeIndicator').innerHTML = `
        <div>MODO YO JEFE</div>
        <div class="level-indicator">${CURRENT_DIFFICULTY.toUpperCase()}</div>
      `;
      document.getElementById('normalControls').style.display = 'none';
      document.getElementById('bossControls').style.display = 'block';
      document.getElementById('energyContainer').classList.remove('active');
      document.getElementById('energyRequirement').style.display = 'none';
    }
    
    this.restart();
    this.startLoop();
  }

  restart() {
    // Detener juego anterior
    this.stop();
    
    // Resetear estados
    this.projectiles = [];
    this.particles = [];
    this.hypnotizedProjectiles = [];
    this.victory = false;
    this.gameOver = false;
    
    // Limpiar controles
    if (CURRENT_VERSION === 'pc') {
      Input.clear();
    } else {
      TouchControls.clear();
    }
    
    // Crear nuevas entidades
    if (CURRENT_MODE === 'normal') {
      this.player = new Player(false);
      this.boss = new Boss(false);
    } else {
      this.player = new Player(true);
      this.boss = new Boss(true);
    }
    
    this.running = true;
    this.lastTime = performance.now();
    
    // Resetear UI
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('shieldContainer').classList.remove('active');
    document.getElementById('shieldButtonContainer').classList.remove('active');
    document.getElementById('damageVignette').classList.remove('active');
    document.getElementById('springAura').classList.remove('active');
    document.getElementById('springAura').innerHTML = '';
    
    // Actualizar UI inicial
    this.updateUI();
  }

  stop() {
    this.running = false;
    this.victory = false;
    this.gameOver = false;
    
    if (this.animationId) {
      cancelAnimationFrame(this.animationId);
      this.animationId = null;
    }
  }

  startLoop() {
    if (this.animationId) {
      cancelAnimationFrame(this.animationId);
    }
    
    const loop = (currentTime) => {
      this.animationId = requestAnimationFrame(loop);
      
      const dt = Math.min((currentTime - this.lastTime) / 1000, 0.1);
      this.lastTime = currentTime;
      
      if(this.running) {
        this.update(dt, currentTime);
        this.draw();
      }
    };
    
    this.lastTime = performance.now();
    this.animationId = requestAnimationFrame(loop);
  }

  spawnProjectile(x, y, vx, vy, owner, color, sizeMultiplier = 1.0) {
    this.projectiles.push(new Projectile(x, y, vx, vy, owner, color, sizeMultiplier));
  }

  spawnParticle(x, y, color, type = 'spark') {
    this.particles.push(new Particle(x, y, color, type));
  }

  triggerDamageVignette() {
    const vignette = document.getElementById('damageVignette');
    vignette.classList.add('active');
    setTimeout(() => {
      vignette.classList.remove('active');
    }, 150);
  }

  update(dt, time) {
    if(!this.player || !this.boss) return;

    // Actualizar entidades
    if (CURRENT_MODE === 'normal') {
      this.player.update(dt, time);
      this.boss.update(dt, time, this.player.x, this.player.y);
    } else {
      this.player.update(dt, time, this.boss.x, this.boss.y);
      this.boss.update(dt, time, this.player.x, this.player.y);
    }

    // Actualizar Proyectiles - MEC√ÅNICA CORREGIDA DEL RESORTE
    for (let i = this.projectiles.length - 1; i >= 0; i--) {
      const p = this.projectiles[i];
      
      // Comportamiento especial para proyectiles hipnotizados
      if (p.hypnotized) {
        p.update(dt, this.boss);
      } else {
        p.update(dt);
      }

      // Eliminar proyectiles fuera de pantalla (solo si no est√°n hipnotizados)
      if(!p.hypnotized && (p.x < -100 || p.x > CONFIG.width + 100 || p.y < -100 || p.y > CONFIG.height + 100)) {
        this.projectiles.splice(i, 1);
        continue;
      }

      let hit = false;

      // COLISIONES seg√∫n modo - MEC√ÅNICA CORREGIDA
      if (CURRENT_MODE === 'normal') {
        // MODO NORMAL: jugador -> jefe
        if(p.owner === 'player') {
          if(Utils.rectIntersect(p, this.boss)) {
            if(this.boss.shieldActive) {
              // REBOTE EN ESCUDO - CORREGIDO
              if(!p.bounced) {
                p.bounceFromShield();
                this.boss.takeShieldDamage();
                this.spawnParticle(p.x, p.y, CONFIG.colors.shield, 'spark');
              }
            } else {
              // DA√ëO REAL
              this.boss.hp -= CONFIG.player.damageToBoss;
              hit = true;
              this.spawnParticle(p.x, p.y, CONFIG.colors.boss, 'spark');
              
              // A√±adir energ√≠a por impacto
              this.player.addEnergy();
            }
          }
        }
        // MODO NORMAL: jefe -> jugador - MEC√ÅNICA DEL RESORTE CORREGIDA
        else if(p.owner === 'boss') {
          if(Utils.rectIntersect(p, this.player)) {
            // Si el jugador tiene el resorte activo, hipnotizar el proyectil
            if (this.player.energyActive && !p.hypnotized) {
              p.hypnotize(this.boss);
              this.hypnotizedProjectiles.push(p);
              this.spawnParticle(p.x, p.y, CONFIG.colors.hypnotized, 'spark');
            } 
            // Da√±o normal si no hay resorte
            else if(!p.hypnotized) {
              const levelConfig = LEVEL_CONFIGS[CURRENT_LEVEL] || LEVEL_CONFIGS[1];
              this.player.hp -= levelConfig.bossDamage;
              hit = true;
              this.spawnParticle(p.x, p.y, CONFIG.colors.player, 'spark');
              this.triggerDamageVignette();
            }
          }
        }
        // MODO NORMAL: proyectiles hipnotizados -> jefe - SEGUIMIENTO PERFECTO
        else if(p.